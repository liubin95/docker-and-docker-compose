# 搭建集群

### 虚拟机准备

#### centos7 * 3

- 桥接网络

#### 免密登陆

```shell
ssh-keygen
ssh-copy-id root@linux-2
# 同步文件
rsync -av /etc/containerd/config.toml root@linux-2:/etc/containerd/config.toml 

```

#### 转发 IPv4 并让 iptables 看到桥接流量

```shell
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# 设置所需的 sysctl 参数，参数在重新启动后保持不变
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 应用 sysctl 参数而不重新启动
sudo sysctl --system

```

#### 时区

```shell
timedatectl set-timezone Asia/Shanghai

```

#### 防火墙设置

```shell
# 放行 kube-apiserve 端口
sudo firewall-cmd --zone=public --add-port=6443/tcp --permanent
sudo firewall-cmd --zone=public --add-port=8080/tcp --permanent

# 放行 etcd 端口
sudo firewall-cmd --zone=public --add-port=2379/tcp --permanent
sudo firewall-cmd --zone=public --add-port=2380/tcp --permanent

# 放行 kubelet 端口
sudo firewall-cmd --zone=public --add-port=10250/tcp --permanent
sudo firewall-cmd --zone=public --add-port=10255/tcp --permanent

# 放行 kube-proxy 端口
sudo firewall-cmd --zone=public --add-port=10256/tcp --permanent

# 重新加载防火墙配置
sudo firewall-cmd --reload

# 升级firewalld
yum update -y firewalld
# 局域网放行
sudo firewall-cmd --zone=public --add-rich-rule='rule family="ipv4" source address="192.168.50.0/24" port protocol="tcp" port="2000-30000" accept' --permanent
sudo firewall-cmd --zone=public --add-rich-rule='rule family="ipv4" source address="127.0.0.1" port protocol="tcp" port="2000-30000" accept' --permanent
# 重新加载防火墙配置
sudo firewall-cmd --reload

```

#### 关闭交换区

```shell
swapoff -a
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

```

#### 关闭selinux

> 你必须这么做，直到 kubelet 做出对 SELinux 的支持进行升级为止。

```shell
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

```

### [容器运行时](https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/)

> 说明： 自 1.24 版起，Dockershim 已从 Kubernetes 项目中移除。阅读 Dockershim 移除的常见问题了解更多详情。

#### containerd

##### [安装](https://github.com/containerd/containerd/blob/main/docs/getting-started.md)

```shell
yum install -y yum-utils
yum-config-manager \
  --add-repo \
  https://download.docker.com/linux/centos/docker-ce.repo
yum install -y containerd.io
systemctl start containerd
systemctl enable --now containerd

```

##### [nerdctl：用于 containerd 的 Docker 兼容 CLI](https://github.com/containerd/nerdctl)

```shell
wget https://github.com/containerd/nerdctl/releases/download/v1.3.1/nerdctl-full-1.3.1-linux-amd64.tar.gz
tar -xzvf nerdctl-full-1.3.1-linux-amd64.tar.gz -C /usr/local
nerdctl run hello-world

```

##### 配置文件

```toml
#   cat /etc/containerd/config.toml
#   Copyright 2018-2022 Docker Inc.

#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at

#       http://www.apache.org/licenses/LICENSE-2.0

#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

disabled_plugins = ["zfs", "devmapper"]

#root = "/var/lib/containerd"
#state = "/run/containerd"
#subreaper = true
#oom_score = 0

#[grpc]
#  address = "/run/containerd/containerd.sock"
#  uid = 0
#  gid = 0

#[debug]
#  address = "/run/containerd/debug.sock"
#  uid = 0
#  gid = 0
#  level = "info"
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
SystemdCgroup = true
[plugins."io.containerd.grpc.v1.cri"]
sandbox_image = "registry.k8s.io/pause:3.2"
```

### [安装 kubeadm、kubelet 和 kubectl](https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

你需要在**每台机器**上安装以下的软件包：

- kubeadm：用来初始化集群的指令。
- kubelet：在集群中的每个节点上用来启动 Pod 和容器等。
- kubectl：用来与集群通信的命令行工具。

#### 安装

```shell
# 如果由于该 Red Hat 的发行版无法解析 basearch
# 导致获取 baseurl 失败，请将 \$basearch 替换为你计算机的架构。
# 输入 uname -m 以查看该值。 例如，x86_64 的 baseurl URL 可以是：https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64。
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF

sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

sudo systemctl enable --now kubelet

```

#### 配置 cgroup 驱动程序

> 所以对基于 kubeadm 的安装， 我们推荐使用 systemd 驱动，不推荐 cgroupfs 驱动。
> 说明： 在版本 1.22 中，如果用户没有在 KubeletConfiguration 中设置 cgroupDriver 字段， kubeadm 会将它设置为默认值 systemd。

```yaml
# kubeadm-config.yaml
kind: ClusterConfiguration
apiVersion: kubeadm.k8s.io/v1beta3
kubernetesVersion: v1.27.1
---
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
cgroupDriver: systemd

```

```shell
kubeadm init --cluster-cidr=10.244.0.0/16 --config /etc/kubeadm-config.yaml
#  if you are the root user, you can run:
# 写入环境变量
export KUBECONFIG=/etc/kubernetes/admin.conf

# You should now deploy a pod network to the cluster.
#Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
# https://kubernetes.io/docs/concepts/cluster-administration/addons/
kubeadm join 192.168.50.222:6443 --token token \
  --discovery-token-ca-cert-hash sha256:97b0e1365436c5aaca0bb3b95ca258f8c48276a32f767da77780d5bbb7392df3

```

### 网络插件

```yaml
# cni 插件已经在nerdctl安装过了
# 需要修改一下默认的位置
env:
  - name: CNI_BIN_DIR
    value: "/usr/local/bin"
```

```shell
wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
kubectl apply -f kube-flannel.yml
kubectl get pods --all-namespaces

```

### 设置k8s 命令补全

```shell
yum install bash-completion
curl -o /usr/share/bash-completion/completions/kubectl https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/kubectl.sh
source /usr/share/bash-completion/bash_completion
echo 'source <(kubectl completion bash)' >>~/.bashrc
source ~/.bashrc
```
